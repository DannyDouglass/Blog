
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Simplify Using Xml Data with AutoMapper and Linq-to-Xml - Danny Douglass</title>
  <meta name="author" content="Danny Douglass">

  
  <meta name="description" content="I recently ran into a scenario at work that required manually consuming several SOAP web services, which I’m sure you can imagine was rather &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://DannyDouglass.github.io//github/blog/2010/11/06/simplify-using-xml-data-with-automapper-and-linqtoxml">
  <link href="/github/favicon.png" rel="icon">
  <link href="/github/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/github/atom.xml" rel="alternate" title="Danny Douglass" type="application/atom+xml">
  <script src="/github/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/github/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  

</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner">
</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/github/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:DannyDouglass.github.io//github" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/github/">Blog</a></li>
  <li><a href="/github/blog/archives">Archives</a></li>
  <li><a href="/github/about">About</a></li>
  <li><a href="/github/bookshelf">Bookshelf</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
  
    
      <h1 class="entry-title">Simplify Using Xml Data With AutoMapper and Linq-to-Xml</h1>
    
  
    
      <p class="meta">
        








  


<time datetime="2010-11-06T13:50:09-04:00" pubdate data-updated="true">Nov 6<span>th</span>, 2010</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>I recently ran into a scenario at work that required manually consuming several SOAP web services, which I’m sure you can imagine was rather monotonous. A co-worker (Seth Carney) and I tried a few different approaches, but we finally settled on a solution that simplified consumption of the xml and ultimately made the code more testable.  That solution centered around leveraging <a href="https://github.com/jbogard/AutoMapper">AutoMapper</a>, an open source object-object mapping tool, to create a link between the <a href="http://msdn.microsoft.com/en-us/library/system.xml.linq.xelement.aspx">XElements</a> returned in the SOAP messages and custom contracts we created &ndash; in a reusable manner.</p>

<p>I put together a quick demo that shows how you could use the same approach to consume and display the <a href="http://api.twitter.com/1/statuses/public_timeline.xml">Twitter Public Timeline</a> (using the API’s Xml response type).</p>

<p><strong>Note</strong>: The source code for the following example can be found on my GitHub page: <a href="https://github.com/DannyDouglass/AutoMapperXmlMappingDemo">https://github.com/DannyDouglass/AutoMapperXmlMappingDemo</a></p>

<h3>1. Getting the Project Setup</h3>

<p>After creating a basic MVC3 (<a href="http://www.asp.net/mvc/mvc3">download beta</a>) project and the associated test project, the first step was to get the AutoMapper package installed.  I have been using <a href="http://nuget.codeplex.com/">NuGet</a>, Microsoft’s recently announced package management system, to install any open source dependencies.  The following command was all that was needed to setup AutoMapper in my MVC3 project (read more about NuGet <a href="http://weblogs.asp.net/scottgu/archive/2010/10/06/announcing-nupack-asp-net-mvc-3-beta-and-webmatrix-beta-2.aspx%20http://weblogs.asp.net/scottgu/archive/2010/10/06/announcing-nupack-asp-net-mvc-3-beta-and-webmatrix-beta-2.aspx%20http://weblogs.asp.net/scottgu/archive/2010/10/06/announcing-nupack-asp-net-mvc-3-beta-and-webmatrix-beta-2.aspx%20http://weblogs.asp.net/scottgu/archive/2010/10/06/announcing-nupack-asp-net-mvc-3-beta-and-webmatrix-beta-2.aspx">here</a> and <a href="http://www.hanselman.com/blog/CategoryView.aspx?category=Nupack">here</a>):</p>

<pre><code>PM&gt; add-package AutoMapper
</code></pre>

<h3>2. Creating the Mapping</h3>

<p>With AutoMapper installed I’m ready to get started creating the components necessary for the xml-to-object mapping.  The first step is creating a quick contract used in my application to represent the Tweet object:</p>

<pre><code>public interface ITweetContract
{
    ulong Id { get; set; }
    string Name { get; set; }
    string UserName { get; set; }
    string Body { get; set; }
    string ProfileImageUrl { get; set; }
    string Created { get; set; }
}
</code></pre>

<p>Nothing crazy here – just a simple entity.  These are all fields that are provided in the response from the Twitter API using a different name for some fields.  In simple cases where the source and destination objects have the same name you can setup a map very quickly using this syntax:</p>

<pre><code>Mapper.CreateMap&lt;SourceObj, DestinationObj&gt;();
</code></pre>

<p>However, AutoMapper does not support Xml by default I have to specify the fields that I will be mapping.  Using the Fluent API in AutoMapper I’m able to chain my field mappings.  Take a look at one example field mapped in my example – the tweet’s <strong>Body:</strong></p>

<pre><code>Mapper.CreateMap&lt;XElement, ITweetContract&gt;()
    .ForMember(
        dest =&gt; dest.Body,
        options =&gt; options.ResolveUsing&lt;XElementResolver&lt;string&gt;&gt;()
            .FromMember(source =&gt; source.Element("text")))
</code></pre>

<p>It may look complicated at first, but all that is really happening here is that we are providing details to AutoMapper on what value to use in my source object and how to map it to the destination object’s property.  There is one particular line I would like to focus on in the above <strong>Body</strong> field mapping:</p>

<pre><code>options =&gt; options.ResolveUsing&lt;XElementResolver&lt;ulong&gt;&gt;()
                        .FromMember(source =&gt; source.Element("id")))  
</code></pre>

<p>The <em>XElementResolver </em>is a <a href="http://automapper.codeplex.com/wikipage?title=Custom%20Value%20Resolvers">custom value resolver</a> that Seth came up with to handle parsing the XmlElement source object to retrieve a strongly-typed value for use in the mapping.  I’ll detail that more in a moment, but before we move on take a look at my full mapping:</p>

<pre><code>Mapper.CreateMap&lt;XElement, ITweetContract&gt;()
    .ForMember(
        dest =&gt; dest.Id,
        options =&gt; options.ResolveUsing&lt;XElementResolver&lt;ulong&gt;&gt;()
            .FromMember(source =&gt; source.Element("id")))
    .ForMember(
        dest =&gt; dest.Name,
        options =&gt; options.ResolveUsing&lt;XElementResolver&lt;string&gt;&gt;()
            .FromMember(source =&gt; source.Element("user")
                .Descendants("name").Single()))
    .ForMember(
        dest =&gt; dest.UserName,
        options =&gt; options.ResolveUsing&lt;XElementResolver&lt;string&gt;&gt;()
            .FromMember(source =&gt; source.Element("user")
                .Descendants("screen_name").Single()))
    .ForMember(
        dest =&gt; dest.Body,
        options =&gt; options.ResolveUsing&lt;XElementResolver&lt;string&gt;&gt;()
            .FromMember(source =&gt; source.Element("text")))
    .ForMember(
        dest =&gt; dest.ProfileImageUrl,
        options =&gt; options.ResolveUsing&lt;XElementResolver&lt;string&gt;&gt;()
            .FromMember(source =&gt; source.Element("user")
                .Descendants("profile_image_url").Single()))
    .ForMember(
        dest =&gt; dest.Created,
        options =&gt; options.ResolveUsing&lt;XElementResolver&lt;string&gt;&gt;()
            .FromMember(source =&gt; source.Element("created_at")));
</code></pre>

<h3>3. The Generic XElementResolver</h3>

<p>This custom value resolver is the real key that allowed these XElement-to-Contract maps to work in the original solution.  I’ve reused this resolver in this example as we saw above.  This was all that was necessary to create the custom resolver class:</p>

<pre><code>public class XElementResolver&lt;T&gt; : ValueResolver&lt;XElement, T&gt;
{
    protected override T ResolveCore(XElement source)
    {
        if (source == null || string.IsNullOrEmpty(source.Value))
            return default(T);  
        return (T)Convert.ChangeType(source.Value, typeof(T));
    }
}
</code></pre>

<p>This generic XElementResolver allows use to easily pass the type of the value retrieved in our mapping above.  For example, the following syntax is used to strongly type the value retrieved from the XmlElement in the <em>Id</em> field’s <em>.ForMember()</em> declaration above:</p>

<pre><code>ResolveUsing&lt;XElementResolver&lt;ulong&gt;&gt;()
</code></pre>

<p>With my mapping completely configured and instantiated, I’m ready to invoke the Twitter API and leverage AutoMapper to display that latest Public Timeline.</p>

<h3>4. Putting the Pieces Together</h3>

<p>I created a simple class responsible for retrieving the Twitter API response:</p>

<pre><code>public class TwitterTimelineRetriever
{
    private readonly XDocument _twitterTimelineXml;  
    public TwitterTimelineRetriever()
    {
        _twitterTimelineXml = XDocument
            .Load("http://api.twitter.com/1/statuses/public_timeline.xml");
    }  
    public IEnumerable&lt;ITweetContract&gt; GetPublicTimeline(int numberOfTweets)
    {
        var tweets = _twitterTimelineXml.Descendants("status")
            .Take(numberOfTweets);  
        return tweets.Select(Mapper.Map&lt;XElement, ITweetContract&gt;).ToList();
    }
}
</code></pre>

<p>The <em>GetPublicTimeline</em> method is a simple method returning, you guessed it, the Twitter Public Timeline by leveraging the map we created earlier:</p>

<pre><code>return tweets.Select(Mapper.Map&lt;XElement, ITweetContract&gt;).ToList();
</code></pre>

<p>In my MVC3 site’s <em>HomeController </em>I can make a quick call to the retrieval method, requesting the last 10 results:</p>

<pre><code>public class HomeController : Controller
{
    private TwitterTimelineRetriever _twitterTimelineRetriever;  
    public ActionResult Index()
    {
        _twitterTimelineRetriever = new TwitterTimelineRetriever();  
        ViewModel.Message = "Twitter Public Timeline";  
        return View(_twitterTimelineRetriever.GetPublicTimeline(10));
    }
}
</code></pre>

<p>And finally, after a little formatting in my <a href="https://github.com/DannyDouglass/AutoMapperXmlMappingDemo/blob/master/AutoMapperXmlDemo.Web/Views/Home/Index.cshtml">View</a> using the new <a href="http://weblogs.asp.net/scottgu/archive/2010/07/02/introducing-razor.aspx">Razor</a> view engine from Microsoft, I have my public timeline displaying!</p>

<p><a href="http://dannydouglass.com/images/2010-11-06-simplify-using-xml-data-with-automapper-and-linqtoxml/Screenshot_TwitterAutoMapperXmlMappingDemo_thumb.png"><img src="/github/images/2010-11-06-simplify-using-xml-data-with-automapper-and-linqtoxml/Screenshot_TwitterAutoMapperXmlMappingDemo_thumb.png" alt="Screenshot_TwitterAutoMapperXmlMappingDemo" /></a></p>

<p>I know we had a hard time finding a lot of content on how to leverage AutoMapper to map Xml sources, so hopefully this is as helpful to you as it was for us.  As I mentioned before, the source is available on my <a href="https://github.com/DannyDouglass/">GitHub page</a> (that I am just starting to utilize):</p>

<p><a href="https://github.com/DannyDouglass/AutoMapperXmlMappingDemo">https://github.com/DannyDouglass/AutoMapperXmlMappingDemo</a></p>

<p>I’d love to hear any other ways people are using AutoMapper with an Xml source.  Shoot me an email at <a href="mailto:me@DannyDouglass.com">me@DannyDouglass.com</a> if you have an alternative solution.</p>

<p>Cheers!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">DannyDouglass</span></span>

      








  


<time datetime="2010-11-06T13:50:09-04:00" pubdate data-updated="true">Nov 6<span>th</span>, 2010</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://DannyDouglass.github.io//github/blog/2010/11/06/simplify-using-xml-data-with-automapper-and-linqtoxml/" data-via="DannyDouglass" data-counturl="http://DannyDouglass.github.io//github/blog/2010/11/06/simplify-using-xml-data-with-automapper-and-linqtoxml/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/github/blog/2010/10/27/console2powershellposhhg/" title="Previous Post: A Better Hg Command Line Interface: Console2 + PowerShell + Posh-Hg">&laquo; A Better Hg Command Line Interface: Console2 + PowerShell + Posh-Hg</a>
      
      
        <a class="basic-alignment right" href="/github/blog/2011/02/24/create-a-recursive-ruby-script-to-replace-file-and-directory-names-and-file-contents/" title="Next Post: How to: Create a Recursive Ruby Script to replace File/Directory Names and File Contents">How to: Create a Recursive Ruby Script to replace File/Directory Names and File Contents &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/github/blog/2011/02/24/create-a-recursive-ruby-script-to-replace-file-and-directory-names-and-file-contents/">How to: Create a Recursive Ruby Script to replace File/Directory Names and File Contents</a>
      </li>
    
      <li class="post">
        <a href="/github/blog/2010/11/06/simplify-using-xml-data-with-automapper-and-linqtoxml/">Simplify Using Xml Data with AutoMapper and Linq-to-Xml</a>
      </li>
    
      <li class="post">
        <a href="/github/blog/2010/10/27/console2powershellposhhg/">A Better Hg Command Line Interface: Console2 + PowerShell + Posh-Hg</a>
      </li>
    
      <li class="post">
        <a href="/github/blog/2010/10/06/nupack-vs-nuproj-vs-openwrap/">NuPack vs. Nu (Nubular) vs. OpenWrap</a>
      </li>
    
      <li class="post">
        <a href="/github/blog/2010/10/01/dcaltnet-package-management-presentation/">Presentation Materials from ALT.NET Presentation on Package Management</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/DannyDuglass">@DannyDuglass</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'DannyDuglass',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/github/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/ddouglass@gmail.com?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Danny Douglass <br/>
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a>, customized with <a href="https://github.com/mjhea0/whiterspace">whiterspace</a>.</span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
